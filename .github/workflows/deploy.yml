name: Deploy to Yandex Object Storage

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # позволяет запускать вручную из GitHub Actions

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check secrets
        run: |
          if [ -z "${{ secrets.YC_ACCESS_KEY }}" ]; then
            echo "ERROR: YC_ACCESS_KEY is not set"
            exit 1
          fi
          if [ -z "${{ secrets.YC_SECRET_KEY }}" ]; then
            echo "ERROR: YC_SECRET_KEY is not set"
            exit 1
          fi
          if [ -z "${{ secrets.YC_BUCKET }}" ]; then
            echo "ERROR: YC_BUCKET is not set"
            exit 1
          fi
          echo "All secrets are set"

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install s3cmd
        run: sudo apt-get update && sudo apt-get install -y s3cmd

      - name: Configure s3cmd
        run: |
          cat > ~/.s3cfg <<EOF
          access_key = ${{ secrets.YC_ACCESS_KEY }}
          secret_key = ${{ secrets.YC_SECRET_KEY }}
          host_base = storage.yandexcloud.net
          host_bucket = %(bucket)s.storage.yandexcloud.net
          signature_v2 = False
          use_https = True
          EOF

      - name: List dist files before upload
        run: |
          echo "Files to upload:"
          find dist -type f | head -20
          echo "Total files: $(find dist -type f | wc -l)"

      - name: Clean up incorrect paths
        run: |
          # Удаляем папку "." если она была создана при предыдущем деплое
          echo "Cleaning up incorrect paths..."
          s3cmd ls -r s3://${{ secrets.YC_BUCKET }}/ 2>/dev/null | awk '{print $4}' | grep -E "s3://.*/\./" | while read -r file; do
            echo "Deleting incorrect path: $file"
            s3cmd del "$file" || true
          done || echo "No incorrect paths found"

      - name: Upload all files to bucket root
        run: |
          # Загружаем все файлы из dist в корень бакета с правильными путями
          echo "Uploading files from dist/ to bucket root..."
          
          # Сначала загружаем HTML файлы с заголовками без кеша
          find dist -name "*.html" -type f | while read -r file; do
            rel_path="${file#dist/}"
            echo "Uploading HTML: $rel_path -> s3://${{ secrets.YC_BUCKET }}/$rel_path"
            s3cmd put \
              --force \
              --no-check-md5 \
              --acl-public \
              --guess-mime-type \
              --add-header='Cache-Control:no-cache, no-store, must-revalidate' \
              --add-header='Pragma:no-cache' \
              --add-header='Expires:0' \
              --verbose \
              "$file" "s3://${{ secrets.YC_BUCKET }}/$rel_path"
          done
          
          # Затем загружаем все остальные файлы
          find dist -type f ! -name "*.html" | while read -r file; do
            rel_path="${file#dist/}"
            echo "Uploading: $rel_path -> s3://${{ secrets.YC_BUCKET }}/$rel_path"
            s3cmd put \
              --force \
              --no-check-md5 \
              --acl-public \
              --guess-mime-type \
              --no-mime-magic \
              --verbose \
              "$file" "s3://${{ secrets.YC_BUCKET }}/$rel_path"
          done

      - name: Delete old files not in dist
        run: |
          # Удаляем файлы из бакета, которых нет в dist (но не из папки ".")
          echo "Checking for files to delete..."
          s3cmd ls -r s3://${{ secrets.YC_BUCKET }}/ | awk '{print $4}' | sed "s|s3://${{ secrets.YC_BUCKET }}/||" | grep -v "^\./" | while read -r remote_file; do
            # Пропускаем пустые строки
            if [ -z "$remote_file" ]; then
              continue
            fi
            local_file="dist/$remote_file"
            if [ ! -f "$local_file" ]; then
              echo "Deleting old file: $remote_file"
              s3cmd del "s3://${{ secrets.YC_BUCKET }}/$remote_file" || true
            fi
          done

      - name: Verify uploaded files
        run: |
          echo "Checking uploaded files in bucket:"
          s3cmd ls -r s3://${{ secrets.YC_BUCKET }}/ | head -20
          echo ""
          echo "Latest file modification times:"
          s3cmd ls -r s3://${{ secrets.YC_BUCKET }}/ | sort -k1,2 | tail -10
